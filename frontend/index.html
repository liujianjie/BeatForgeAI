<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeatForge AI - AIç”µéŸ³åˆ¶ä½œå·¥ä½œç«™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 50%, #0a1a2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        /* å¤´éƒ¨ */
        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(138, 43, 226, 0.3);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8a2be2, #00d4ff);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo h1 {
            font-size: 24px;
            background: linear-gradient(90deg, #8a2be2, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .logo span {
            font-size: 12px;
            color: #888;
        }

        .status-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge.online {
            background: rgba(0, 255, 100, 0.1);
            border: 1px solid rgba(0, 255, 100, 0.3);
            color: #00ff64;
        }

        .status-badge.offline {
            background: rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.3);
            color: #ff3232;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online { background: #00ff64; }
        .status-dot.offline { background: #ff3232; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ä¸»å†…å®¹ */
        .main {
            max-width: 1000px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* ç”Ÿæˆé¢æ¿ */
        .panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(138, 43, 226, 0.2);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title .icon {
            font-size: 22px;
        }

        /* è¡¨å• */
        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #aaa;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 10px;
            color: #e0e0e0;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #8a2be2;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        /* é£æ ¼é€‰æ‹© */
        .style-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .style-card {
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(138, 43, 226, 0.15);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .style-card:hover {
            border-color: rgba(138, 43, 226, 0.5);
            background: rgba(138, 43, 226, 0.1);
        }

        .style-card.active {
            border-color: #8a2be2;
            background: rgba(138, 43, 226, 0.2);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
        }

        .style-card .name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .style-card .desc {
            font-size: 11px;
            color: #888;
        }

        /* æ»‘å— */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: rgba(138, 43, 226, 0.3);
            border-radius: 3px;
            border: none;
            padding: 0;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #8a2be2;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #8a2be2;
        }

        /* ç”ŸæˆæŒ‰é’® */
        .generate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #8a2be2, #6a1bb2);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
        }

        .generate-btn:hover {
            background: linear-gradient(135deg, #9a3bf2, #7a2bc2);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(138, 43, 226, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .generate-btn .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        .generate-btn.loading .spinner {
            display: block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç»“æœé¢æ¿ */
        .result-panel {
            display: none;
        }

        .result-panel.show {
            display: block;
        }

        .audio-player {
            width: 100%;
            margin: 16px 0;
            border-radius: 10px;
        }

        .audio-player audio {
            width: 100%;
        }

        .result-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .info-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }

        .info-card .label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .info-card .value {
            font-size: 18px;
            font-weight: 700;
            color: #00d4ff;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            background: rgba(0, 212, 255, 0.15);
            border: 1px solid rgba(0, 212, 255, 0.4);
            border-radius: 8px;
            color: #00d4ff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            margin-top: 16px;
        }

        .download-btn:hover {
            background: rgba(0, 212, 255, 0.25);
        }

        /* å†å²è®°å½• */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.3s;
        }

        .history-item:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .history-item .name {
            font-size: 14px;
            font-weight: 500;
        }

        .history-item .meta {
            font-size: 12px;
            color: #888;
        }

        .history-item .actions {
            display: flex;
            gap: 8px;
        }

        .history-item .actions button {
            padding: 6px 12px;
            background: rgba(138, 43, 226, 0.2);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 6px;
            color: #ccc;
            font-size: 12px;
            cursor: pointer;
        }

        .history-item .actions button:hover {
            background: rgba(138, 43, 226, 0.4);
        }

        /* é”™è¯¯æç¤º */
        .error-msg {
            background: rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.3);
            border-radius: 10px;
            padding: 14px 18px;
            color: #ff6b6b;
            margin-top: 16px;
            display: none;
        }

        .error-msg.show {
            display: block;
        }

        /* é¡µè„š */
        .footer {
            text-align: center;
            padding: 24px;
            color: #555;
            font-size: 13px;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .style-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            .result-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨ -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ğŸµ</div>
            <div>
                <h1>BeatForge AI</h1>
                <span>AIç”µéŸ³åˆ¶ä½œå·¥ä½œç«™ v0.1.0</span>
            </div>
        </div>
        <div id="statusBadge" class="status-badge offline">
            <div class="status-dot offline"></div>
            <span>æ£€æŸ¥è¿æ¥ä¸­...</span>
        </div>
    </header>

    <!-- ä¸»å†…å®¹ -->
    <main class="main">
        <!-- AIç”Ÿæˆé¢æ¿ -->
        <div class="panel">
            <div class="panel-title">
                <span class="icon">ğŸ¤–</span>
                AIç”µéŸ³ç”Ÿæˆ
            </div>

            <!-- æç¤ºè¯è¾“å…¥ -->
            <div class="form-group">
                <label>ğŸ¤ éŸ³ä¹æè¿°æç¤ºè¯</label>
                <textarea id="promptInput" placeholder="æè¿°ä½ æƒ³è¦çš„ç”µéŸ³é£æ ¼ï¼Œä¾‹å¦‚ï¼šenergetic drop with heavy bass and synth leads, festival vibes"></textarea>
            </div>

            <!-- é£æ ¼é€‰æ‹© -->
            <div class="form-group">
                <label>ğŸ¹ ç”µéŸ³é£æ ¼</label>
                <div class="style-grid" id="styleGrid">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
            </div>

            <!-- å‚æ•°æ§åˆ¶ -->
            <div class="form-row-3">
                <div class="form-group">
                    <label>â±ï¸ BPM (èŠ‚æ‹é€Ÿåº¦)</label>
                    <div class="slider-container">
                        <input type="range" id="bpmSlider" min="60" max="200" value="128">
                        <span class="slider-value" id="bpmValue">128</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>â³ æ—¶é•¿ (ç§’)</label>
                    <div class="slider-container">
                        <input type="range" id="durationSlider" min="5" max="30" value="10">
                        <span class="slider-value" id="durationValue">10s</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>âš¡ èƒ½é‡å¼ºåº¦</label>
                    <div class="slider-container">
                        <input type="range" id="energySlider" min="0" max="100" value="70">
                        <span class="slider-value" id="energyValue">70%</span>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ¼ è°ƒå¼</label>
                    <select id="keySelect">
                        <option value="C">C å¤§è°ƒ</option>
                        <option value="D">D å¤§è°ƒ</option>
                        <option value="E">E å¤§è°ƒ</option>
                        <option value="F">F å¤§è°ƒ</option>
                        <option value="G">G å¤§è°ƒ</option>
                        <option value="A">A å¤§è°ƒ</option>
                        <option value="B">B å¤§è°ƒ</option>
                        <option value="Am">A å°è°ƒ</option>
                        <option value="Dm">D å°è°ƒ</option>
                        <option value="Em">E å°è°ƒ</option>
                    </select>
                </div>
                <div class="form-group" style="display:flex; align-items:flex-end;">
                    <button class="generate-btn" id="generateBtn" onclick="generateMusic()">
                        <span class="spinner"></span>
                        <span class="btn-text">ğŸš€ å¼€å§‹ç”Ÿæˆ</span>
                    </button>
                </div>
            </div>

            <!-- é”™è¯¯æç¤º -->
            <div class="error-msg" id="errorMsg"></div>
        </div>

        <!-- ç»“æœé¢æ¿ -->
        <div class="panel result-panel" id="resultPanel">
            <div class="panel-title">
                <span class="icon">ğŸ§</span>
                ç”Ÿæˆç»“æœ
            </div>

            <div class="audio-player">
                <audio id="audioPlayer" controls></audio>
            </div>

            <div class="result-info">
                <div class="info-card">
                    <div class="label">ç”Ÿæˆè€—æ—¶</div>
                    <div class="value" id="genTime">-</div>
                </div>
                <div class="info-card">
                    <div class="label">éŸ³é¢‘æ—¶é•¿</div>
                    <div class="value" id="audioDuration">-</div>
                </div>
                <div class="info-card">
                    <div class="label">ä½¿ç”¨è®¾å¤‡</div>
                    <div class="value" id="deviceInfo">-</div>
                </div>
            </div>

            <a class="download-btn" id="downloadBtn" href="#" download>
                ğŸ“¥ ä¸‹è½½WAVæ–‡ä»¶
            </a>
        </div>

        <!-- å†å²è®°å½• -->
        <div class="panel">
            <div class="panel-title">
                <span class="icon">ğŸ“‹</span>
                ç”Ÿæˆå†å²
            </div>
            <div class="history-list" id="historyList">
                <div style="text-align:center; color:#666; padding:20px;">
                    æš‚æ— ç”Ÿæˆè®°å½•ï¼Œå¼€å§‹åˆ›ä½œä½ çš„ç¬¬ä¸€é¦–ç”µéŸ³å§ï¼
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="footer">
        BeatForge AI Â© 2024 | Powered by Meta MusicGen | Made with â¤ï¸
    </footer>

    <script>
        const API_BASE = window.location.origin + '/api';
        let selectedStyle = 'house';
        let generationHistory = [];

        // ========== åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadStyles();
            checkHealth();
            setupSliders();
        });

        // ========== å¥åº·æ£€æŸ¥ ==========
        async function checkHealth() {
            const badge = document.getElementById('statusBadge');
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                badge.className = 'status-badge online';
                badge.innerHTML = `
                    <div class="status-dot online"></div>
                    <span>æœåŠ¡åœ¨çº¿ (${data.device})</span>
                `;
            } catch (e) {
                badge.className = 'status-badge offline';
                badge.innerHTML = `
                    <div class="status-dot offline"></div>
                    <span>æœåŠ¡ç¦»çº¿</span>
                `;
            }
        }

        // ========== åŠ è½½é£æ ¼ ==========
        async function loadStyles() {
            const grid = document.getElementById('styleGrid');
            try {
                const res = await fetch(`${API_BASE}/ai/styles`);
                const data = await res.json();
                
                grid.innerHTML = data.styles.map(style => `
                    <div class="style-card ${style.id === selectedStyle ? 'active' : ''}" 
                         onclick="selectStyle('${style.id}', this)"
                         title="${style.description}">
                        <div class="name">${style.name}</div>
                        <div class="desc">${style.bpm_range[0]}-${style.bpm_range[1]} BPM</div>
                    </div>
                `).join('');
            } catch (e) {
                // ä½¿ç”¨é»˜è®¤é£æ ¼
                const defaultStyles = [
                    { id: 'house', name: 'House', desc: '120-130 BPM' },
                    { id: 'techno', name: 'Techno', desc: '125-140 BPM' },
                    { id: 'dubstep', name: 'Dubstep', desc: '138-142 BPM' },
                    { id: 'trance', name: 'Trance', desc: '128-140 BPM' },
                    { id: 'ambient', name: 'Ambient', desc: '60-100 BPM' },
                    { id: 'drum_and_bass', name: 'D&B', desc: '160-180 BPM' },
                    { id: 'edm', name: 'EDM', desc: '126-132 BPM' },
                    { id: 'lo_fi', name: 'Lo-Fi', desc: '70-90 BPM' },
                ];
                grid.innerHTML = defaultStyles.map(s => `
                    <div class="style-card ${s.id === selectedStyle ? 'active' : ''}" 
                         onclick="selectStyle('${s.id}', this)">
                        <div class="name">${s.name}</div>
                        <div class="desc">${s.desc}</div>
                    </div>
                `).join('');
            }
        }

        function selectStyle(styleId, el) {
            selectedStyle = styleId;
            document.querySelectorAll('.style-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        // ========== æ»‘å—æ§åˆ¶ ==========
        function setupSliders() {
            const bpmSlider = document.getElementById('bpmSlider');
            const durationSlider = document.getElementById('durationSlider');
            const energySlider = document.getElementById('energySlider');

            bpmSlider.oninput = () => {
                document.getElementById('bpmValue').textContent = bpmSlider.value;
            };
            durationSlider.oninput = () => {
                document.getElementById('durationValue').textContent = durationSlider.value + 's';
            };
            energySlider.oninput = () => {
                document.getElementById('energyValue').textContent = energySlider.value + '%';
            };
        }

        // ========== ç”ŸæˆéŸ³ä¹ ==========
        async function generateMusic() {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                showError('è¯·è¾“å…¥éŸ³ä¹æè¿°æç¤ºè¯ï¼');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.classList.remove('show');

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½
            btn.disabled = true;
            btn.classList.add('loading');
            btn.querySelector('.btn-text').textContent = 'ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...';

            const requestBody = {
                prompt: prompt,
                style: selectedStyle,
                bpm: parseInt(document.getElementById('bpmSlider').value),
                duration: parseInt(document.getElementById('durationSlider').value),
                key: document.getElementById('keySelect').value,
                energy: parseInt(document.getElementById('energySlider').value) / 100.0,
            };

            try {
                const res = await fetch(`${API_BASE}/ai/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                const data = await res.json();

                if (data.success) {
                    showResult(data);
                    addToHistory(data, requestBody);
                } else {
                    showError(data.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (e) {
                showError(`è¯·æ±‚å¤±è´¥: ${e.message}ã€‚è¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ã€‚`);
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.querySelector('.btn-text').textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
            }
        }

        // ========== æ˜¾ç¤ºç»“æœ ==========
        function showResult(data) {
            const panel = document.getElementById('resultPanel');
            panel.classList.add('show');

            // éŸ³é¢‘æ’­æ”¾å™¨
            const audioUrl = window.location.origin + data.download_url;
            const player = document.getElementById('audioPlayer');
            player.src = audioUrl;

            // ä¿¡æ¯å¡ç‰‡
            document.getElementById('genTime').textContent = data.generation_time + 's';
            document.getElementById('audioDuration').textContent = data.duration + 's';
            document.getElementById('deviceInfo').textContent = 
                data.metadata ? data.metadata.device.toUpperCase() : '-';

            // ä¸‹è½½æŒ‰é’®
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.href = audioUrl;
            downloadBtn.download = data.filename;

            // æ»šåŠ¨åˆ°ç»“æœ
            panel.scrollIntoView({ behavior: 'smooth' });
        }

        // ========== å†å²è®°å½• ==========
        function addToHistory(data, request) {
            generationHistory.unshift({
                filename: data.filename,
                url: data.download_url,
                style: request.style,
                prompt: request.prompt,
                duration: data.duration,
                time: new Date().toLocaleTimeString(),
            });

            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if (generationHistory.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">æš‚æ— è®°å½•</div>';
                return;
            }

            list.innerHTML = generationHistory.map((item, i) => `
                <div class="history-item">
                    <div>
                        <div class="name">${item.style.toUpperCase()} - ${item.prompt.substring(0, 30)}...</div>
                        <div class="meta">${item.time} | ${item.duration}s</div>
                    </div>
                    <div class="actions">
                        <button onclick="playHistoryItem(${i})">â–¶ æ’­æ”¾</button>
                        <button onclick="downloadHistoryItem(${i})">ğŸ“¥ ä¸‹è½½</button>
                    </div>
                </div>
            `).join('');
        }

        function playHistoryItem(index) {
            const item = generationHistory[index];
            const player = document.getElementById('audioPlayer');
            player.src = window.location.origin + item.url;
            player.play();
            document.getElementById('resultPanel').classList.add('show');
        }

        function downloadHistoryItem(index) {
            const item = generationHistory[index];
            const a = document.createElement('a');
            a.href = window.location.origin + item.url;
            a.download = item.filename;
            a.click();
        }

        // ========== é”™è¯¯æç¤º ==========
        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 8000);
        }
    </script>
</body>
</html>
